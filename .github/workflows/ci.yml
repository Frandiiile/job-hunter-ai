name: CI Pipeline

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  lint:
    name: Code Quality Checks
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python 3.10
      uses: actions/setup-python@v6
      with:
        python-version: "3.10"

    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements-dev.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements-dev.txt

    - name: Check code formatting with black
      run: black --check --diff src/ scripts/ tests/
      continue-on-error: true

    - name: Lint with flake8
      run: |
        # Stop the build if there are Python syntax errors or undefined names
        flake8 src/ scripts/ tests/ --count --select=E9,F63,F7,F82 --show-source --statistics
        # Exit-zero treats all errors as warnings. Max line length set to 100
        flake8 src/ scripts/ tests/ --count --exit-zero --max-complexity=10 --max-line-length=100 --statistics
      continue-on-error: true

  test:
    name: Test Suite
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
        python-version: ["3.10", "3.11", "3.12"]

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v6
      with:
        python-version: ${{ matrix.python-version }}

    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cache/pip
          ~\AppData\Local\pip\Cache
        key: ${{ runner.os }}-pip-${{ matrix.python-version }}-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-${{ matrix.python-version }}-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov

    - name: Verify package structure
      run: |
        python -c "import sys; print(f'Python {sys.version}')"
        python -c "from src.job_hunter_ai.scoring import compute_hybrid_score; print('✓ Scoring imports work')"
        python -c "from src.job_hunter_ai.config import GROQ_MODEL; print(f'✓ Config works: {GROQ_MODEL}')"

    - name: Run import tests
      run: pytest tests/test_imports.py -v --tb=short

    - name: Run all tests with coverage
      run: pytest tests/ -v --cov=src/job_hunter_ai --cov-report=xml --cov-report=term
      continue-on-error: true

    - name: Upload coverage to Codecov
      if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.10'
      uses: codecov/codecov-action@v3
      with:
        files: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false

  integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [lint, test]

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python 3.10
      uses: actions/setup-python@v6
      with:
        python-version: "3.10"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Verify all module imports
      run: |
        echo "Testing core module imports..."
        python -c "from src.job_hunter_ai import compute_hybrid_score, compute_deterministic_score; print('✓ Core imports OK')"
        python -c "from src.job_hunter_ai.llm.enrich import enrich_with_llm, generate_master_cv; print('✓ LLM imports OK')"
        python -c "from src.job_hunter_ai.latex.render_template import render_template; print('✓ LaTeX imports OK')"
        python -c "from src.job_hunter_ai.drive.upload import upload_to_drive; print('✓ Drive imports OK')"

    - name: Check script imports
      run: |
        echo "Checking script files for import errors..."
        python -m py_compile scripts/filter_jobs.py
        python -m py_compile scripts/generate_docs_for_job.py
        python -m py_compile scripts/test_llm_generation.py
        echo "✓ All scripts compile successfully"

    - name: Validate configuration
      run: |
        python -c "
        from src.job_hunter_ai.config import PROJECT_ROOT, PROFILE_DIR, PROMPTS_DIR, TEMPLATES_DIR
        print(f'Project root: {PROJECT_ROOT}')
        print(f'Profile dir exists: {PROFILE_DIR.exists()}')
        print(f'Prompts dir exists: {PROMPTS_DIR.exists()}')
        print(f'Templates dir exists: {TEMPLATES_DIR.exists()}')
        assert PROFILE_DIR.exists(), 'Profile directory not found'
        assert PROMPTS_DIR.exists(), 'Prompts directory not found'
        assert TEMPLATES_DIR.exists(), 'Templates directory not found'
        print('✓ All directories validated')
        "

  security:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python 3.10
      uses: actions/setup-python@v6
      with:
        python-version: "3.10"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install safety bandit

    - name: Check for security vulnerabilities in dependencies
      run: |
        pip install -r requirements.txt
        safety check --json || true
      continue-on-error: true

    - name: Run Bandit security linter
      run: bandit -r src/ -ll -f json -o bandit-report.json || true
      continue-on-error: true

    - name: Upload Bandit report
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: bandit-security-report
        path: bandit-report.json

  build-status:
    name: Build Status
    runs-on: ubuntu-latest
    needs: [lint, test, integration, security]
    if: always()

    steps:
    - name: Check build status
      run: |
        echo "Lint status: ${{ needs.lint.result }}"
        echo "Test status: ${{ needs.test.result }}"
        echo "Integration status: ${{ needs.integration.result }}"
        echo "Security status: ${{ needs.security.result }}"

        if [ "${{ needs.lint.result }}" == "failure" ] || [ "${{ needs.test.result }}" == "failure" ] || [ "${{ needs.integration.result }}" == "failure" ]; then
          echo "❌ Build failed"
          exit 1
        else
          echo "✅ Build passed"
        fi
